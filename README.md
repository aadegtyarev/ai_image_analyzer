# ai_image_analyzer

Python‚Äë–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å –ø–æ–º–æ—â—å—é OpenAI‚Äë—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö vision‚Äë–º–æ–¥–µ–ª–µ–π.

## üñº Running the bot and programmatic API

The old monolithic CLI (`python ai_image_analyzer.py`) has been deprecated and moved to `legacy/`.

To run the Telegram bot locally use the thin runner:

```bash
python bot.py
```

For programmatic usage prefer the library API:

```python
from ai_image_analyzer import handle_json_request

# Example: analyze two images as a collage
req = {
  "action": "analyze",
  "images": [
    {"name": "a.jpg", "data_b64": "..."},
    {"name": "b.jpg", "data_b64": "..."},
  ],
  "per_image": False,
  "include_billing": True,
}
resp = handle_json_request(req)
```

If you still need a CLI-style helper, use the thin runner or the package APIs directly ‚Äî the legacy CLI lives in `legacy/` for reference.

See `examples/` for small runnable examples demonstrating how to use the
package programmatically (e.g. `examples/analyzer_service_example.py`).
* `OPENAI_BALANCE_THRESHOLD` ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —á–∏—Å–ª–æ–≤–æ–π –ø–æ—Ä–æ–≥ –±–∞–ª–∞–Ω—Å–∞ (–≤ –≤–∞–ª—é—Ç–µ —Å–µ—Ä–≤–∏—Å–∞). –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ (`--check-balance`) –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å –º–µ–Ω—å—à–µ –ø–æ—Ä–æ–≥–∞, —Å–∫—Ä–∏–ø—Ç –≤—ã–≤–µ–¥–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.
* –ü–æ–ª—è `usage` (prompt_tokens/completion_tokens/total_tokens/total_cost) –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞. `total_cost` –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –¥–æ 3 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π. –í CLI –≤—ã–≤–æ–¥–∏—Ç—Å—è `USAGE:` —Å —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω `-q`).

---

## üñº CLI-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–û–±—â–∏–π —Ñ–æ—Ä–º–∞—Ç:

```bash
python ai_image_analyzer.py [OPTIONS] [images...]

* `-p, --PROMPT_FILE` ‚Äî –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–∞–π–ª –ø—Ä–æ–º—Ç–∞ (`PROMPT_FILE` –∏–∑ `.env`).
* `-t, --text` ‚Äî —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–∫ `user` (PROMPT_FILE –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, —Ñ–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è).
* `--check-balance` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –≤—ã–≤–µ—Å—Ç–∏ JSON.
* `-q, --quiet` ‚Äî —Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º (–º–∏–Ω–∏–º—É–º –ª–æ–≥–æ–≤, –ø–æ–¥–∞–≤–ª—è–µ—Ç –≤—ã–≤–æ–¥ USAGE).

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ CLI:

```text
--OPENAI_API_KEY, -k
--OPENAI_BASE_URL, -u
--OPENAI_MODEL, -m
--OPENAI_TIMEOUT, -T
--OPENAI_MAX_TOKENS, -M
--IMAGE_MAX_SIZE, -s
--IMAGE_QUALITY, -Q
--COLLAGE_MAX_SIZE, -S
--COLLAGE_QUALITY, -G
--PROMPT_FILE, -p
```

### 1Ô∏è‚É£ –û–¥–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞

–°–æ–∑–¥–∞—ë—Ç `photo_analyse.md` —Ä—è–¥–æ–º —Å —Ñ–∞–π–ª–æ–º:

```bash
python ai_image_analyzer.py images/photo.jpg
```

### 2Ô∏è‚É£ –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–æ–∫ (–¥–æ 10, –∫–æ–ª–ª–∞–∂)

–°–æ–∑–¥–∞—ë—Ç—Å—è –∫–æ–ª–ª–∞–∂ –∏ –æ–¥–∏–Ω –æ–±—â–∏–π —Ñ–∞–π–ª `group_YYYYMMDD_HHMMSS_analyse.txt`:

```bash
python ai_image_analyzer.py "images/*.jpg"
```

### 3Ô∏è‚É£ –†–µ–∂–∏–º `--per-image` (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –Ω–∞ –∫–∞–∂–¥—É—é)

–ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Üí `*_analyse.md`:

```bash
python ai_image_analyzer.py --per-image "images/*.jpg"
```

### 4Ô∏è‚É£ –ö–∞—Ä—Ç–∏–Ω–∫–∞ + —Ç–µ–∫—Å—Ç (PROMPT_FILE –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è)

–û—Ç–≤–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å, —Ñ–∞–π–ª—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è:

```bash
python ai_image_analyzer.py images/photo.jpg -t "–†–∞–∑–±–µ—Ä–∏ –∫–∞–¥—Ä –∫–∞–∫ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫"
```

### 5Ô∏è‚É£ –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç

–ë–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:

```bash
python ai_image_analyzer.py -t "–ü—Ä–µ–¥–ª–æ–∂–∏ –∏–¥–µ—é —Ñ–æ—Ç–æ—Å–µ—Ä–∏–∏ –æ –∑–∏–º–Ω–µ–π –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏"
```

---

## üìÇ –ü—Ä–æ–º–ø—Ç—ã

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–º–ø—Ç—ã –ª–µ–∂–∞—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `prompts/`:

* `PROMPT_FILE` —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º—Ç–æ–º.

–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

```text
prompts/
  art_analysis.txt
  series_idea.txt
  mentor_simple.txt
```

---

## üìù –ó–∞–º–µ—á–∞–Ω–∏—è

* –ú–∞–∫—Å–∏–º—É–º **10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.
* –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—Å–∞–π–∑—è—Ç—Å—è –¥–æ `IMAGE_MAX_SIZE` –ø–æ –¥–ª–∏–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ.
* –ö–æ–ª–ª–∞–∂ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç —Å–µ—Ç–∫—É (N√óN, N√óM).
* –í CLI –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–≤–æ—è OpenAI-—Å–µ—Å—Å–∏—è.

üìå –°–º. `CHANGELOG.md` –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

## üêû –û—Ç–ª–∞–¥–∫–∞

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

- `DEBUG=1` ‚Äî –æ–±—â–∏–π –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ (–∫–æ—Ä–æ—Ç–∫–∏–µ snippet'—ã system/user prompt –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è).
- `IMAGE_DEBUG=1` ‚Äî –ø–µ—á–∞—Ç–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º (`[IMAGE_DEBUG] image #...`).

- `DEBUG=1` ‚Äî –æ–±—â–∏–π –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ (–∫–æ—Ä–æ—Ç–∫–∏–µ snippet'—ã system/user prompt –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è). –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ `DEBUG` —Ç–∞–∫–∂–µ –ø–µ—á–∞—Ç–∞—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–º—Ç–æ–≤ –¥–ª—è –∞–ª—å–±–æ–º–æ–≤ (`[MEDIA_DEBUG] set media context ...` / `[MEDIA_DEBUG] expired media context ...`).
- `IMAGE_DEBUG=1` ‚Äî –ø–µ—á–∞—Ç–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º (`[IMAGE_DEBUG] image #...`).

–ü—Ä–∏–º–µ—Ä:

```bash
DEBUG=1 IMAGE_DEBUG=1 python bot.py
```

Docker (basic):

```bash
docker compose up --build -d
```

---

## Deploy (install-as-service)

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: `~/applications/ai_image_analyzer/`.

–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ (–ø–æ–¥ `sudo`):

```bash
sudo ./deploy/install-as-service.sh \
  --install-dir /home/$USER/applications/ai_image_analyzer \
  --user $USER
```

–ö–æ—Ä–æ—Ç–∫–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:
- –∫–ª–æ–Ω–∏—Ä—É–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ;
- —Å–æ–∑–¥–∞—ë—Ç `venv` –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏;
- —Å–æ–∑–¥–∞—ë—Ç `.env` (–µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç) –∏ —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–º–µ—Å—Ç–∏—Ç—å —Ç—É–¥–∞ `BOT_TOKEN` –∏ `BOT_ADMIN_ID`;
  - –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞. –í –Ω–µ–≥–æ –ø–æ–º–µ—â–∞—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:
    ```text
    OPENAI_API_KEY=your_api_key
    BOT_TOKEN=your_telegram_bot_token
    BOT_ADMIN_ID=123456789
    ```
    –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–º. –≤ `env.example`.
- —Å—Ç–∞–≤–∏—Ç systemd unit `/etc/systemd/system/ai_image_analyzer.service`, –≤–∫–ª—é—á–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–∏—Å;
- –ª–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã: `sudo journalctl -u ai_image_analyzer -f`.

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –±–æ—Ç–∞ –ø–æ–¥ —Å–≤–æ–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º (user unit) –∏–ª–∏ –≤—Ä—É—á–Ω—É—é ‚Äî —Å–º. `deploy/README.md`.

---

### –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –º–æ–¥—É–ª—è `prompts_utils.py`

–í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –±—ã–ª —Ñ–∞–π–ª `prompts_utils.py`, –Ω–æ –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏—è `load_prompts` –±—ã–ª–∞ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ —É–¥–∞–ª–µ–Ω–∞ (–æ–Ω–∞ –±—Ä–æ—Å–∞–µ—Ç RuntimeError) –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ. –Ø —É–¥–∞–ª–∏–ª —ç—Ç–æ—Ç —Ñ–∞–π–ª –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `bot.load_prompts` –∏ —Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–æ–º–ø—Ç–æ–≤ –≤ `bot.py`.


```
::contentReference[oaicite:1]{index=1}
```
